import { StatusCodes } from "http-status-codes";
import Mission from "../models/MissionModel.js";
import { NotFoundError } from "../errors/customError.js";
import Submission from "../models/SubmissionModel.js";
import { TYPEPOSTURES } from "../utils/constants.js";

export const getAllMissions = async (req, res) => {
  console.log("\n====================================");
  console.log("üîç Request Query:", req.query);
  const { search, sort, page, limit, missionType } = req.query;

  // Print out all available mission types from constants
  console.log("üîç TYPEPOSTURES from constants:", TYPEPOSTURES);
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á queryObject ‡πÇ‡∏î‡∏¢‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà isDeleted !== true
  const queryObject = { isDeleted: { $ne: true } };

  // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ search parameter ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å no ‡∏´‡∏£‡∏∑‡∏≠ name
  if (search) {
    console.log("üîç Searching for:", search);
    
    // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ - ‡πÅ‡∏¢‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö no ‡πÅ‡∏•‡∏∞ name
    const searchConditions = [];
    
    // ‡∏ñ‡πâ‡∏≤ search ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÉ‡∏´‡πâ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å no ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    const numberSearch = Number(search);
    if (!isNaN(numberSearch)) {
      searchConditions.push({ no: numberSearch });
    }
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å name ‡∏î‡πâ‡∏ß‡∏¢ regex
    searchConditions.push({ name: { $regex: search, $options: "i" } });
    
    queryObject.$or = searchConditions;
  }

  // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ missionType - ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏£‡∏≠‡∏á‡∏î‡πâ‡∏ß‡∏¢ name ‡πÅ‡∏ó‡∏ô
  if (missionType && missionType !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
    console.log("üîç Filtering by mission type:", missionType);
    
    // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏û‡∏ö‡∏ß‡πà‡∏≤ mission ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏°‡∏µ type ‡πÄ‡∏õ‡πá‡∏ô "‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏ó‡πà‡∏≤‡πÉ‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô" ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô‡∏´‡∏°‡∏î
    // ‡πÅ‡∏ï‡πà‡∏ä‡∏∑‡πà‡∏≠ mission ‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ó‡∏µ‡πà‡∏Ñ‡∏ß‡∏£‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô
    // ‡∏à‡∏∂‡∏á‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ mission ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å missionType
    
    // 1. ‡∏Å‡∏£‡∏≠‡∏á mission ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ missionType ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤
    if (!queryObject.$or) {
      queryObject.$or = [];
    }
    
    // ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ß‡πà‡∏≤ missionType ‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏î‡πÉ‡∏ô TYPEPOSTURES
    let matchingTypeValues = [];
    const typepostureValues = Object.values(TYPEPOSTURES);
    
    if (typepostureValues.includes(missionType)) {
      matchingTypeValues.push(missionType);
    } else {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡πÉ‡∏ô TYPEPOSTURES ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ
      for (const [key, value] of Object.entries(TYPEPOSTURES)) {
        if (value.includes(missionType) || missionType.includes(value)) {
          matchingTypeValues.push(value);
        }
      }
    }
    
    console.log("üîç Matching type values:", matchingTypeValues);
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á mission ‡πÅ‡∏ó‡∏ô mission type
    matchingTypeValues.forEach(typeValue => {
      queryObject.$or.push({ name: { $regex: typeValue, $options: "i" } });
    });
    
    // 2. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ missionType ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
    if (queryObject.$or.length === 0) {
      queryObject.$or.push({ name: { $regex: missionType, $options: "i" } });
    }
  }

  console.log("üîç Final query object:", JSON.stringify(queryObject, null, 2));

  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î pagination
  const pageNum = Number(page) || 1;
  const limitNum = Number(limit) || 30;
  const skip = (pageNum - 1) * limitNum;

  try {
    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£ sort ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏°‡∏≤
    console.log("üîç Sort parameter:", sort);
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° submissions ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const isSortBySubmissions = 
      sort === "‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡πà‡∏≤ ‡∏ô‡πâ‡∏≠‡∏¢-‡∏°‡∏≤‡∏Å" || 
      sort === "‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡πà‡∏≤ ‡∏°‡∏≤‡∏Å-‡∏ô‡πâ‡∏≠‡∏¢";
      
    if (isSortBySubmissions) {
      console.log("üîç Sorting by submission count");
      
      // First, get all missions with their submission counts for sorting
      const missionsWithCounts = await Mission.aggregate([
        { $match: queryObject },
        { 
          $addFields: { 
            submissionCount: { $size: { $ifNull: ["$submission", []] } } 
          } 
        },
        { $sort: { submissionCount: sort === "‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡πà‡∏≤ ‡∏°‡∏≤‡∏Å-‡∏ô‡πâ‡∏≠‡∏¢" ? -1 : 1 } },
        { $skip: skip },
        { $limit: limitNum }
      ]);
      
      console.log(`üîç Found ${missionsWithCounts.length} missions for sorting by submission count`);
      
      // Get the IDs of the sorted missions
      const missionIds = missionsWithCounts.map(m => m._id);
      
      // Then use a normal find with populate to get the full mission data with the proper sorted order
      const missions = await Mission.find({ _id: { $in: missionIds } })
        .populate({
          path: "submission",
          model: "submissions",
        });
      
      // Sort the results to match the original order from the aggregation
      const orderedMissions = missionIds.map(id => 
        missions.find(m => m._id.toString() === id.toString())
      ).filter(Boolean);
      
      const totalMissions = await Mission.countDocuments(queryObject);
      const numOfPages = Math.ceil(totalMissions / limitNum);
      
      console.log(`üîç Final mission count after populate: ${orderedMissions.length}`);
      
      if (orderedMissions.length > 0 && orderedMissions.length <= 10) {
        console.log("üîç Mission results sample (sorted by submission count):");
        orderedMissions.slice(0, 10).forEach(m => {
          const submissionCount = m.submission ? m.submission.length : 0;
          console.log(`  ID: ${m._id}, Name: ${m.name}, Submissions: ${submissionCount}`);
        });
      }
      
      // ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á client
      return res.status(StatusCodes.OK).json({
        totalMissions,
        numOfPages,
        currentPage: pageNum,
        missions: orderedMissions,
      });
    }
    
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° submissions ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥
    const sortOptions = {
      "‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î": "-createdAt",
      "‡πÄ‡∏Å‡πà‡∏≤‡∏™‡∏∏‡∏î": "createdAt",
      "‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏Å-‡∏Æ": "name",
      "‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ä‡∏∑‡πà‡∏≠ ‡∏Æ-‡∏Å": "-name",
    };
    
    // ‡πÉ‡∏ä‡πâ sortKey ‡∏à‡∏≤‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    const sortKey = sortOptions[sort] || "-createdAt";
    console.log("üîç Using sort key:", sortKey);
    
    // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ find ‡πÅ‡∏•‡∏∞ sort ‡∏õ‡∏Å‡∏ï‡∏¥
    const missions = await Mission.find(queryObject)
      .sort(sortKey)
      .skip(skip)
      .limit(limitNum)
      .populate({
        path: "submission",
        model: "submissions",
      });
    
    const totalMissions = await Mission.countDocuments(queryObject);
    const numOfPages = Math.ceil(totalMissions / limitNum);
    
    console.log(`üîç Found ${missions.length} missions out of ${totalMissions} total`);
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ
    if (missions.length > 0 && missions.length <= 10) {
      console.log("üîç Mission results sample:");
      missions.slice(0, 10).forEach(m => {
        const submissionCount = m.submission ? m.submission.length : 0;
        console.log(`  ID: ${m._id}, No: ${m.no}, Name: ${m.name}, Type: ${m.missionType}, Submissions: ${submissionCount}`);
      });
    } 
    
    // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    else if (missions.length === 0 && missionType && missionType !== "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î") {
      console.log("‚ö†Ô∏è No missions found with this filter. Sample data without filter:");
      
      const anyMissions = await Mission.find({ isDeleted: { $ne: true } }).limit(5);
      if (anyMissions.length > 0) {
        anyMissions.forEach(m => {
          const submissionCount = m.submission ? m.submission.length : 0;
          console.log(`  ID: ${m._id}, No: ${m.no}, Name: ${m.name}, Type: ${m.missionType}, Submissions: ${submissionCount}`);
        });
      } else {
        console.log("‚ö†Ô∏è No missions found in database at all");
      }
    }
    
    console.log("====================================\n");
    
    // ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏¢‡∏±‡∏á client
    res.status(StatusCodes.OK).json({
      totalMissions,
      numOfPages,
      currentPage: pageNum,
      missions,
    });

  } catch (error) {
    console.error("‚ùå Error in getAllMissions:", error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      msg: "Error retrieving missions",
      error: error.message
    });
  }
};

export const createMission = async (req, res) => {
  const { no, name, isEvaluate, missionType } = req.body;
  console.log("üîç Creating mission with data:", req.body);
  
  if (!missionType) {
    console.log("‚ö†Ô∏è Warning: No missionType provided in request");
  }
  
  const newMission = new Mission({
    no: no,
    name,
    isEvaluate,
    missionType: missionType // Make sure missionType is included
  });

  try {
    await newMission.save();
    console.log("‚úÖ Mission created successfully with data:", {
      id: newMission._id,
      no: newMission.no,
      name: newMission.name,
      missionType: newMission.missionType
    });
    
    res.status(StatusCodes.CREATED).json({
      msg: "Mission created successfully"
    });
  } catch (error) {
    console.error("‚ùå Error creating mission:", error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      msg: "Error creating mission",
      error: error.message
    });
  }
};

export const getMission = async (req, res) => {
  const { id } = req.params;
  const mission = await Mission.findById(id).populate({
    path: 'submission',
    model: 'submissions'
  });
  if (!mission) throw new NotFoundError(`No mission with id: ${id}`);
  res.status(StatusCodes.OK).json({ mission });
};

export const updateMissionWithSubmissions = async (req, res) => {
  const { id } = req.params;
  const { submissionUpdates, ...missionData } = req.body;

  try {
    // Update mission data
    const mission = await Mission.findById(id);
    if (!mission) throw new NotFoundError(`No mission with id: ${id}`);

    // Update mission fields
    Object.assign(mission, missionData);
    await mission.save();

    // Update submissions if provided
    if (submissionUpdates && Array.isArray(submissionUpdates)) {
      const updatePromises = submissionUpdates.map(async (subUpdate) => {
        if (!subUpdate._id) return null;

        const submission = await Submission.findById(subUpdate._id);
        if (!submission) {
          console.warn(`Submission not found with id: ${subUpdate._id}`);
          return null;
        }

        Object.assign(submission, {
          name: subUpdate.name,
          imageUrl: subUpdate.imageUrl || submission.imageUrl,
          videoUrl: subUpdate.videoUrl || submission.videoUrl,
          evaluate: subUpdate.evaluate
        });

        return submission.save();
      });

      await Promise.all(updatePromises.filter(Boolean));
    }

    // Return updated mission with populated submissions
    const updatedMission = await Mission.findById(id).populate({
      path: 'submission',
      model: 'submissions'
    });

    res.status(StatusCodes.OK).json({ mission: updatedMission });
  } catch (error) {
    console.error('Error in updateMissionWithSubmissions:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      msg: 'Error updating mission and submissions',
      error: error.message
    });
  }
};

export const deleteMission = async (req, res) => {
  const { id } = req.params;
  const mission = await Mission.findById(id);

  for (let i = 0; i < mission.submission.length; i++) {
    const submission = await Submission.findOneAndDelete({ _id: mission.submission[i] });
  }

  if (!mission) throw new NotFoundError(`No mission with id: ${id}`);

  await Mission.findOneAndDelete({ _id: mission._id });

  res.status(StatusCodes.OK).json({ msg: "Mission and associated submissions soft deleted successfully", mission });
};

export const getAllSubmissions = async (req, res) => {
  const submissions = await Submission.find({});
  res.status(StatusCodes.OK).json({ submissions });
};

export const createSubmission = async (req, res) => {
  const submission = await Submission.create(req.body);
  res.status(StatusCodes.CREATED).json({ submission });
};

export const getSubmission = async (req, res) => {
  const { id } = req.params;
  const submission = await Submission.findById(id);
  if (!submission) throw new NotFoundError(`No submission with id: ${id}`);
  res.status(StatusCodes.OK).json({ submission });
};

export const updateSubmission = async (req, res) => {
  const { id } = req.params;
  const submission = await Submission.findByIdAndUpdate(id, req.body, {
    new: true,
  });
  if (!submission) throw new NotFoundError(`No submission with id: ${id}`);
  res.status(StatusCodes.OK).json({ submission });
};

export const deleteSubmission = async (req, res) => {
  const { missionId, submissionId } = req.params;

  const submission = await Submission.findByIdAndDelete(submissionId);
  const mission = await MissionModel.updateOne(
    { _id: missionId },
    { $pull: { submission: submissionId } }
  );

  if (!submission) throw new NotFoundError(`No submission with id: ${mission}`);
  res.status(StatusCodes.OK).json({ msg: "Submission deleted successfully", submission });
};

export const createMissionWithSubmissions = async (req, res) => {
  const { id, submissionsData } = req.body;
  try {
    const submissionToCreate = {
      name: submissionsData.name,
      videoUrl: submissionsData.videoUrl || "",
      imageUrl: submissionsData.imageUrl || "",
      evaluate: submissionsData.evaluate
    };


    const submission = await Submission.create(submissionToCreate);
    const mission = await Mission.updateOne(
      { _id: id },
      { $push: { submission: submission._id } }
    );

    // const populatedMission = await Mission.findById(mission._id).populate({
    //   path: 'submission',
    //   model: 'submissions'
    // });

    res.status(StatusCodes.CREATED).json({ submission });
  } catch (error) {
    console.error('Error in createMissionWithSubmissions:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      msg: 'Error creating mission with submissions',
      error: error.message
    });
  }
};

// Add new function to get soft deleted missions
export const getSoftDeletedMissions = async (req, res) => {
  try {
    const missions = await Mission.find({ isDeleted: true })
      .populate({
        path: 'submission',
        model: 'submissions'
      });
    res.status(StatusCodes.OK).json({ missions });
  } catch (error) {
    console.error('Error in getSoftDeletedMissions:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      msg: 'Error getting soft deleted missions',
      error: error.message
    });
  }
};

// Add function to restore soft deleted missions
export const restoreMission = async (req, res) => {
  const { id } = req.params;
  try {
    const mission = await Mission.findById(id);
    if (!mission) throw new NotFoundError(`No mission with id: ${id}`);

    // Restore the mission
    mission.isDeleted = false;
    await mission.save();

    // Restore associated submissions
    if (mission.submission && mission.submission.length > 0) {
      await Submission.updateMany(
        { _id: { $in: mission.submission } },
        { isDeleted: false }
      );
    }

    res.status(StatusCodes.OK).json({
      msg: "Mission and associated submissions restored successfully",
      mission
    });
  } catch (error) {
    console.error('Error in restoreMission:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      msg: 'Error restoring mission',
      error: error.message
    });
  }
};

